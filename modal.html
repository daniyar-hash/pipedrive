 <!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Custom Modal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <h2>Custom Modal</h2>
  <div id="status">⏳ Загружаем SDK...</div>

  <script>
    // Динамически загружаем скрипт и ждём загрузки
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Не удалось загрузить ' + src));
        document.head.appendChild(s);
      });
    }

    (async () => {
      const status = document.getElementById('status');
      try {
        // primary CDN
        await loadScript('https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js')
          .catch(() => Promise.reject('primary-failed'));

        // Если глобал не установлен — пробуем fallback (unpkg)
        if (!window.PipedriveAppExtensionsSDK) {
          await loadScript('https://unpkg.com/@pipedrive/app-extensions-sdk@0/dist/index.umd.js');
        }

        if (!window.PipedriveAppExtensionsSDK) {
          throw new Error('SDK не найден в window (возможно CSP/блокировка).');
        }

        status.textContent = '✅ SDK загружен, инициализируем...';

        const sdk = await window.PipedriveAppExtensionsSDK.initialize();
        const ctx = await sdk.context.get();

        status.textContent = 'Модалка открыта для сделки #' + (ctx.itemId || ctx.item_id || 'неизвестен');
      } catch (err) {
        console.error('Ошибка SDK:', err);
        status.textContent = '❌ Ошибка SDK: ' + (err.message || err);
        // Подсказка пользователю: смотрите Console/Network
      }
    })();
  </script>
  <script src="pipedrive-sdk.js"></script>
</body>
</html